---
title: "Lung Function Analysis Stat 741 Group Project"
author: "Yifei Xu, Shubh Patel, Max Brown"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
---

## Introduction
Lung function is an important measure of overall health. The data presented to us provides an opportunity to analyze lung function with respect to factors such as age, smoking status, asthma and other factors. We analyze the data and provide relevant models to describe the effect of different life factors and the result on Lung Function. 

Research Questions
1. Do asthmatics have steeper rates of decline (slope) or lower levels of lung function (FEV1) than non-asthmatics, independent of smoking history? 

2. Do asthmatic smokers have steeper rates of decline or lower levels of lung function than non-asthmatic smokers? Here you can explore three options 1) using the fixed effect variable ever smoke, 2) using the time dependent variable for smoking, or 3) using the current number of cigarettes per day. When using this I would suggest making it a categorical variable using quartiles etc.

## Data
We load all packages used for the project and load the data.
```{r setup, include=FALSE}
library(haven)      # To read .dta files
library(tidyverse)  # For data manipulation (dplyr) and plotting (ggplot2)
library(ggcorrplot) # For correlation plot
library(lme4)       # For Random Coefficient Models (mixed models)
library(lmerTest)   # Gives the p-values for lme4 models
library(sjPlot)     # Great for visualizing mixed model results
```

```{r}
# Load the data
data <- read_dta("data/family asthma p1 data version2.dta")
```

## Data Cleaning
First we reshape the data into long format.
```{r}
cleaned_data <- data %>%
  # Reshape using pivot_longer
  pivot_longer(cols = matches("\\d+$"),           
               names_to = c(".value", "survey"),  
               names_pattern = "([a-z]+)(\\d+)") %>% 
  mutate(survey = as.numeric(survey)) %>%
  group_by(id) %>% 
  arrange(survey) %>%
  # data cleaning
  mutate(cncig_new = ifelse(is.na(cncig) & smk %in% c(2, 3), 0, cncig), # replace structural missing of cncig
         is_baseline_ex = first(smk == 2, order_by = survey),
         had_smoked_prev = lag(cumany(cncig_new > 0), default = FALSE),
         smk_new = case_when(cncig_new > 0 ~ 1,                
                             (had_smoked_prev == TRUE | is_baseline_ex == TRUE) & cncig_new == 0 ~ 2,        
                             (had_smoked_prev == FALSE & is_baseline_ex == FALSE) & cncig_new == 0 ~ 3,               
                             TRUE ~ smk), # Keep original if logic doesn't apply
         smkever_new = ifelse(any(smk_new == 1, na.rm = TRUE), 1, 0)) %>% 
  ungroup() %>%
  dplyr::select(-is_baseline_ex, -had_smoked_prev) %>%

  mutate(id = as.factor(id),
         family = as.factor(family),
         # Fixed variables
         sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
         asthma = factor(asthma, levels = c(0, 1), labels = c("Non-Asthma", "Asthma")),
         smkever = factor(smkever, levels = c(0, 1), labels = c("Never-Smoker", "Ever-Smoker")),
         smkever_new = factor(smkever_new, levels = c(0, 1), labels = c("Never-Smoker", "Ever-Smoker")),
         # Time-dependent variables
         age_centered = age - mean(age, na.rm = TRUE),
         smk = factor(smk, levels = c(1, 2, 3), labels = c("Current", "Ex", "Never")),
         smk_new = factor(smk_new, levels = c(1, 2, 3), labels = c("Current", "Ex", "Never")),
         cncig_cat = as.factor(ntile(cncig_new, 4))) %>%
  dplyr::select(id, family, sex, asthma, mwt, mht, smkever, smkever_new, 
                survey, age, smk, smk_new, cncig, cncig_new, fev, fvc) 

```


# Explanatory Analysis

1. Plots of the dependent variable versus time
– visualize shape of the population temporal trends or shape of the curves over time 
– observe potential outliers 
– observe group or treatment difference over time

```{r}
# Visualizing overall trend
cleaned_data %>%
  drop_na(age, fev) %>%
  ggplot(aes(x = age, y = fev)) +
  geom_point(alpha = 0.25, size = 0.5) +
  # Add smooth trend lines (assume linear decline)
  geom_smooth(method = "lm", se = FALSE, linewidth = 1) +
  labs(title = "Population Temporal Trends of FEV1",
       x = "Age (Years)", 
       y = "FEV1 (L)") +
  theme_bw()

# Visualizing group differences (Asthma vs. Non-Asthma)
cleaned_data %>%
  drop_na(age, asthma, fev) %>%
  ggplot(aes(x = age, y = fev, color = as.factor(asthma))) +
  geom_point(alpha = 0.25, size = 0.5) +
  # Add smooth trend lines (assume linear decline)
  geom_smooth(method = "lm", se = FALSE, linewidth = 1) +
  scale_color_manual(values = c("#f8766d", "#00b0f6")) +
  labs(title = "Population Temporal Trends of FEV1 by Asthma Status",
       x = "Age (Years)", 
       y = "FEV1 (L)",
       color = "") +
  theme_bw()
```

2. Plots of individual raw data
- observe temporal trends within subjects
- observe amount of variability within subjects

```{r}
# Sample 50 random IDs to keep the plot readable
set.seed(2026)
sample_ids <- sample(unique(cleaned_data$id), 50)
subset_data <- subset(cleaned_data, id %in% sample_ids)

# Spaghetti Plot
subset_data %>%
  drop_na(age, fev) %>%
  ggplot(aes(x = age, y = fev, group = id)) +
  geom_line(alpha = 0.5, color = "blue") +
  labs(title = "Individual Temporal Trends of FEV1",
       x = "Age (Years)", 
       y = "FEV1 (L)") +
 theme_bw() 


# Boxplot
cleaned_data %>%
  drop_na(fev) %>%
  ggplot(aes(y = fev)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Distribution of FEV1",
       y = "FEV1 (L)") +
 theme_bw() 

cleaned_data %>%
  drop_na(asthma, fev) %>%
  ggplot(aes(x = asthma, y = fev, fill = as.factor(asthma))) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  scale_fill_manual(values = c("#f8766d", "#00b0f6")) +
  labs(title = "Distribution of FEV1",
       x = "", 
       y = "FEV1 (L)",
       fill = "") +
 theme_bw() 

```

3. Patterns of missing observations over time

```{r}
# Tabulate and plot missingness per visit
fev_miss <- cleaned_data %>%
  drop_na(asthma) %>%
  group_by(survey, asthma) %>%
  summarise(
    missing_fev = sum(is.na(fev)),
    pct_missing = (missing_fev / n()) * 100
  )

fev_miss %>% 
  ggplot(aes(x = survey, y = pct_missing, color = as.factor(asthma))) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  scale_color_manual(values=c("#f8766d", "#00b0f6")) +
  scale_x_continuous(breaks = c(1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12), 
                     labels = c(1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12)) +
  labs(title = "Percentage of Missing FEV1 over Time by Asthma Status",
       x = "Survey",
       y = "% Missing FEV1",
       color = "") +
  theme_bw() 

# MAR - Check if the people who left the study look different from those who completed
cleaned_data_comp <- cleaned_data %>%
  drop_na(fev) %>%
  group_by(id) %>%
  mutate(status = ifelse(max(survey) < 12, "Dropped Out", "Completed"))

# Plot FEV1 levels for both groups
cleaned_data_comp %>%
  ggplot(aes(x = status, y = fev, fill = status)) +
  geom_boxplot() +
  scale_fill_manual(values=c("green", "yellow")) +
  labs(title = "FEV1: Dropouts vs. Completers", 
       x = "Study Status",
       y = "FEV1 (L)",
       fill = "") +
  theme_bw()
  
```

4. Correlation Plot

```{r}
cor_data <- data %>%
  select(sex, mwt, mht, asthma, smkever) %>%
  mutate(across(everything(), as.numeric)) %>%
  rename(`Sex` = sex,
         `Mean Weight` = mwt,
         `Mean Height` = mht,
         `Initial Asthma Status` = asthma,
         `Ever Smoked` = smkever)

# Compute the correlation matrix
corr_matrix <- cor(cor_data, use = "pairwise.complete.obs")

# Heatmap
ggcorrplot(corr_matrix, 
           hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           title = "Correlation Between Covariates",
           colors = c("#6D9EC1", "white", "#E46726"),
           outline.col = "white") +
  theme_bw()
```



We will probably want to include more stuff in this section...

## Models
Recall that the mixed linear model has the setup $$Y_i = X\beta + Z\alpha + \epsilon_i $$
where $X$ represents the matrix of fixed effects and $Z$ the matrix of random effects. 
The model we first wish to explore is written as fev ~ age_centered * asthma + sex + mht + smkever + 
                    (1 | family) + (1 + age_centered | id). 
### Model Notes for Group
We will need to explain difference between models. I have compiled some notes about the different models we are utilizing.

### Notes about Random Effects
We might choose to get rid of this for our presentation, but I found it helpful so far while we are modeling.

The notation of our models is generally fev ~ fixed_effects + random_effects

- Model will always contain global intercept unless we specify it to not contain one.

- age_centered * asthma is equivalent to age_centered + asthma + age_centered:asthma (fixed effect portion)

- (1|family) produces the random effect of a random slope for family

  - This is equivalent to the Z matrix being loaded with zeros and ones and columns indicating family.
  
  - This is equivalent of adding $Y_{ijk} = \text{fixed_effects}+ \beta_0 + u_{0,\text{family}_j} + \epsilon$.
    This assumes there is a global intercept in the model, so family can vary from the global average.
    
- (1 + age_centered|id) produces a random intercept and slope for id. In other words, id is allowed to vary randomly from the global intercept and global slope.

  - Z matrix still has 1s and 0s indicating family. Z matrix now also has ages (random coefficients) in separate columns indexed still by family.
  
  - This is equivalent to $Y_{ijk} = \text{fixed_effects} + \beta_0 + u_0 + (\beta_1 + u_{1,i})\text{age}_{ijk}+ \epsilon$
  
- family/id is equivalent to (family) + (family:id). So (1 + age_centered|family/id) is equivalent to 
(1 + age_centered|family) + (1 + age_centered|family:id). Where family:id is essentially just id if each person belongs to 1 family. This model allows for random intercepts for both family and id, and it allows random intercepts for family and id.


### Model 1
This model addresses research question 1. It includes a simple interaction between age_centered and asthma.
The interaction term, age_centered * asthma is equivalent to age_centered + asthma + age_centered:asthma
for the fixed effects. The random effects we chose to include is a random intercept for family and 
random slope and intercept for id.

```{r}
model_rq1 <- lmer(fev ~ age_centered * asthma + sex + mht + smkever + 
                    (1 | family) + (1 + age_centered | id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```


### Model 2
This model is used to address research question 2.
```{r}
# Model 2: Three-way interaction (Age * Asthma * Smoking)
model_rq2 <- lmer(fev ~ age_centered * asthma * smkever + sex + mht + 
                    (1 | family) + (1 + age_centered | id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```

### Model 3
Differs from model 2 in that we have random slope and intercept for both family and id.
```{r}
# Model 3: Three-way interaction (Age * Asthma * Smoking), and changed random effects
model_rq3 <- lmer(fev ~ age_centered * asthma * smkever + sex + mht + 
                    (1 + age_centered | family/id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```


### Model 4
This model uses cncig isntead of smkever in the interaction. The difference is that cncig is
some measure of smoking dosage whereas smkever only measures whether or not the person has
smoked.
```{r}
# Model 4: Three-way interaction (Age * Asthma * Cncig)
# We use the optimizer control to prevent the convergence warning.

model_rq4 <- lmer(fev ~ age_centered * asthma * cncig + sex + mht + 
                    (1 | family) + (1 + age_centered | id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```

### Model 5
This model uses nesting to get random slope and intercept for both family and id.
```{r}
# Model 5: Three-way interaction (Age * Asthma * Cncig)
# We use the optimizer control to prevent the convergence warning.

model_rq5 <- lmer(fev ~ age_centered * asthma * cncig + sex + mht + 
                    (1 + age_centered | family/id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```

## Model Comparisons
One model comparison we would like to do is between models 2 and 3 to see if there is a difference
between them. They are nested models, so the likelihood ratio test is a good test in this example.

```{r}
m2_ML  <- update(model_rq2, REML = FALSE)
m3_ML <- update(model_rq3, REML = FALSE)
anova(m2_ML, m3_ML)
```
This test reveals there is some differences between the models, it is not strong, and could therefore we prefer the simpler model 2.
```{r}
m4_ML  <- update(model_rq4, REML = FALSE)
m5_ML <- update(model_rq5, REML = FALSE)
anova(m2_ML, m3_ML)
```
No significant result comes from this, so we prefer the simpler model.


## Diagnostics

## Conclusions





