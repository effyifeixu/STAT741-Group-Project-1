---
title: "Lung Function Analysis Stat 741 Group Project"
author: "Yifei Xu, Shubh Patel, Max Brown"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
---

## Introduction
We will have to fix this section so it sounds more introductoryish..
1.  Do asthmatics have steeper rates of decline (slope) or lower levels of lung function (FEV1) than non-asthmatics, independent of smoking history? 

2. Do asthmatic smokers have steeper rates of decline or lower levels of lung function than non-asthmatic smokers? Here you can explore three options 1) using the fixed effect variable ever smoke, 2) using the time dependent variable for smoking, or 3) using the current number of cigarettes per day. When using this I would suggest making it a categorical variable using quartiles etc.

## Data
We load all packages used for the project and load the data.
```{r setup, include=FALSE}
library(haven)      # To read .dta files
library(tidyverse)  # For data manipulation (dplyr) and plotting (ggplot2)
library(lme4)       # For Random Coefficient Models (mixed models)
library(lmerTest)   # Gives the p-values for lme4 models
library(sjPlot)     # Great for visualizing mixed model results
```

```{r}
# Load the data
data <- read_dta("data/family asthma p1 data version2.dta")
```

## Data Cleaning
First we reshape the data into long format.
```{r}
# 1. Reshape using pivot_longer
# We use a special regex pattern to strip the numbers (1, 2, 3...) from the variable names
long_data <- data %>%
  pivot_longer(
    cols = matches("\\d+$"),  # Selects columns ending in numbers (e.g., age1, fev12)
    names_to = c(".value", "Survey_Wave"), # Splits into variable name + survey number
    names_pattern = "([a-zA-Z]+)(\\d+)"    # Regex: Letters capture name, Digits capture wave
  ) %>%
  
  # 2. Clean up the data
  mutate(
    Survey_Wave = as.numeric(Survey_Wave), # Convert wave number to numeric
    
    # Ensure ID and Family are factors for the model
    id = as.factor(id),
    family = as.factor(family)
  ) %>%
  
  # 3. Remove rows where the outcome (FEV) is missing 
  # (Mixed models handle missing data well, but rows with no outcome provide no info)
  filter(!is.na(fev)) %>%
  
  # 4. Arrange by Family, then ID, then Time (optional, but good for inspection)
  arrange(family, id, Survey_Wave)

```
Next we introduce factors and clean up other aspects of the data
```{r}
# Data Cleaning steps
cleaned_data <- long_data %>%
  filter(!is.na(fev))
  # 1. Remove rows where the outcome variable (FEV) is missing
  
  # 2. Factorize categorical variables
cleaned_data <- cleaned_data %>%
  mutate(
    # Fixed Variables
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    asthma = factor(asthma, levels = c(0, 1), labels = c("Non-Asthma", "Asthma")),
    smkever = factor(smkever, levels = c(0, 1), labels = c("Never-Smoker", "Ever-Smoker")),
    
    # Time-Dependent Variables
    # Note: Ensure 'smk' is actually 1, 2, 3 in the data. 
    smk = factor(smk, levels = c(1, 2, 3), labels = c("Current", "Ex", "Never"))
  )
  
  # 3. Create Quartiles for 'Cncig' (Option 3 for smoking variables)
cleaned_data <- cleaned_data %>%
  # Optional: Handle NAs if necessary (e.g., if non-smokers are NA, set to 0)
  # mutate(cncig = replace_na(cncig, 0)) %>% 
  
  mutate(
    # Create quartiles for cigarettes per day
    # We use 'ntile' to split data into 4 groups
    cncig_quartile = ntile(cncig, 4), 
    
    # Convert that new variable into a factor
    cncig_cat = as.factor(cncig_quartile)
  )

# 4. Centering Age (Crucial for convergence in Mixed Models)
# It makes the intercept meaningful (e.g., baseline lung function at age 20 or mean age)
cleaned_data$age_centered <- cleaned_data$age - mean(cleaned_data$age, na.rm = TRUE)

# Explanatory Analysis
# Sample 50 random IDs to keep the plot readable
set.seed(2026)
sample_ids <- sample(unique(cleaned_data$id), 50)
subset_data <- subset(cleaned_data, id %in% sample_ids)

```
## Exploratory Analysis
We first analyze different aspects of the data before modeling.
```{r}
# Spaghetti Plot
ggplot(subset_data, aes(x = age, y = fev, group = id)) +
  geom_line(alpha = 0.5, color = "blue") +
  theme_minimal() +
  labs(title = "Individual FEV1 Trajectories (Spaghetti Plot)",
       x = "Age (Years)", y = "FEV1")
```
Visualize the Group Differences (Asthma vs. Non-Asthma)
```{r}
# Visualizing Group Differences (Asthma vs. Non-Asthma)
ggplot(cleaned_data, aes(x = age, y = fev, color = asthma)) +
  # Add smooth trend lines (linear method because we assume linear decline)
  geom_smooth(method = "lm", se = TRUE) +
  theme_minimal() +
  labs(title = "Mean Rate of Decline: Asthma vs Non-Asthma",
       x = "Age", y = "FEV1")
```

We will probably want to include more stuff in this section...

## Models
Recall that the mixed linear model has the setup $$Y_i = X\beta + Z\alpha + \epsilon_i $$
where $X$ represents the matrix of fixed effects and $Z$ the matrix of random effects. 
The model we first wish to explore is written as fev ~ age_centered * asthma + sex + mht + smkever + 
                    (1 | family) + (1 + age_centered | id). 
### Model Notes for Group
We will need to explain difference between models. I have compiled some notes about the different models we are utilizing.

### Notes about Random Effects
We might choose to get rid of this for our presentation, but I found it helpful so far while we are modeling.

The notation of our models is generally fev ~ fixed_effects + random_effects

- Model will always contain global intercept unless we specify it to not contain one.

- age_centered * asthma is equivalent to age_centered + asthma + age_centered:asthma (fixed effect portion)

- (1|family) produces the random effect of a random slope for family

  - This is equivalent to the Z matrix being loaded with zeros and ones and columns indicating family.
  
  - This is equivalent of adding $Y_{ijk} = \text{fixed_effects}+ \beta_0 + u_{0,\text{family}_j} + \epsilon$.
    This assumes there is a global intercept in the model, so family can vary from the global average.
    
- (1 + age_centered|id) produces a random intercept and slope for id. In other words, id is allowed to vary randomly from the global intercept and global slope.

  - Z matrix still has 1s and 0s indicating family. Z matrix now also has ages (random coefficients) in separate columns indexed still by family.
  
  - This is equivalent to $Y_{ijk} = \text{fixed_effects} + \beta_0 + u_0 + (\beta_1 + u_{1,i})\text{age}_{ijk}+ \epsilon$
  
- family/id is equivalent to (family) + (family:id). So (1 + age_centered|family/id) is equivalent to 
(1 + age_centered|family) + (1 + age_centered|family:id). Where family:id is essentially just id if each person belongs to 1 family. This model allows for random intercepts for both family and id, and it allows random intercepts for family and id.


### Model 1
This model is for research question 1, and we need to explain and justify our modeling decisions.
For example, why did we leave weight out of the model... ect

```{r}
model_rq1 <- lmer(fev ~ age_centered * asthma + sex + mht + smkever + 
                    (1 | family) + (1 + age_centered | id),
                  data = cleaned_data,
                  REML = TRUE,
                  control = lmerControl(optimizer = "bobyqa",
                                        optCtrl = list(maxfun = 2e5)))
```

### Model 2

## Model Comparisons

## Diagnostics

## Conclusions





